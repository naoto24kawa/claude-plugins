---
name: developing-cloudflare-solutions
description: Cloudflareサービスの実装、エッジコンピューティング設計、Workers/Pages/R2/D1/KV等の構築を支援。MCP サーバーを活用した自動化、デプロイメント、設定管理を正確にサポート。「Cloudflare実装」「Workers開発」「Pages デプロイ」「R2ストレージ」「D1データベース」「エッジ関数」「CDN設定」などの依頼時に使用
---

## Cloudflare ソリューション開発支援スキル

## 目次

1. [使用例](#使用例)
2. [基本原則](#基本原則)
3. [開発ワークフロー](#開発ワークフロー)
4. [専門分野とサービスカタログ](#専門分野とサービスカタログ)
5. [実装パターンとベストプラクティス](#実装パターンとベストプラクティス)
6. [実装例](#実装例)
7. [デフォルト設定](#デフォルト設定)
8. [注意事項](#注意事項)
9. [エラーハンドリング](#エラーハンドリング)
10. [依存関係](#依存関係)

---

このスキルは、Cloudflare サービスの実装とエッジコンピューティング設計を、MCP サーバーと公式ドキュメントに基づいて正確にサポートします。Cloudflare の全サービス（Workers、Pages、R2、D1、KV、Durable Objects、Stream 等）の開発支援を提供します。

## 使用例

### 例1: Workers 関数の実装

```
状況: REST API のエッジ関数を Workers で実装したい
要求: TypeScript、D1 データベース連携、認証機能
期待: 実装コード、wrangler.toml 設定、デプロイ手順
```

### 例2: Pages アプリケーションのデプロイ

```
状況: Next.js アプリケーションを Cloudflare Pages にデプロイ
要求: 環境変数設定、カスタムドメイン、プレビュー環境
期待: デプロイ設定、ビルドコマンド、トラブルシューティング
```

### 例3: R2 + Workers のデータパイプライン

```
状況: 画像アップロード・最適化・配信システムの構築
要求: R2 ストレージ、Workers での画像変換、キャッシュ戦略
期待: アーキテクチャ設計、実装コード、パフォーマンス最適化
```

## 基本原則

### 1. MCP サーバー駆動開発

すべての実装は、`cloudflare:mcp-server-cloudflare` を通じて取得したリソース情報とベストプラクティスに基づいて行います。

**必須アクション**:
- サービスの制限事項、API、設定について MCP サーバーで確認
- 現在のゾーン設定やリソース状態を取得してから設計
- MCP ツールの参照元を明示

### 2. エッジファーストアーキテクチャ

**設計原則**:
- エッジでの処理を最大化し、オリジンへのリクエストを最小化
- グローバル分散を考慮したステートレス設計
- キャッシュ戦略をアーキテクチャの中心に配置

### 3. コストとパフォーマンスの最適化

**考慮事項**:
- Workers の CPU 時間と実行回数を最適化
- R2 のストレージクラスと egress を考慮
- 無料枠とペイドプランの境界を明確に提示

## 開発ワークフロー

### ステップ1: 要件分析とサービス選定

**実施内容**:
- ユーザーの要求を分析し、適切な Cloudflare サービスを特定
- エッジコンピューティングの適用可能性を評価
- 既存インフラとの統合要件を確認

**検証**:
- 選定したサービスが要件を満たすか確認
- サービスの制限事項（CPU 時間、メモリ、ストレージ等）を検証

### ステップ2: MCP サーバーでリソース確認

**実施内容**:
- MCP ツールを使用して現在のゾーン設定を取得
- DNS レコード、Page Rules、Workers Routes を確認
- 既存のリソースとの競合や依存関係を特定

**使用する MCP ツール**:
- リソース一覧取得
- ゾーン設定確認
- アナリティクスデータ取得

### ステップ3: アーキテクチャ設計

**実施内容**:
- エッジコンピューティングのアーキテクチャ設計
- データフローとキャッシュ戦略の決定
- セキュリティ境界とアクセス制御の設計

**設計時の考慮事項**:
- **グローバル分散**: マルチリージョン配置、レイテンシ最適化
- **スケーラビリティ**: オートスケーリング、負荷分散
- **セキュリティ**: WAF ルール、DDoS 保護、Zero Trust
- **パフォーマンス**: CDN キャッシュ、エッジ処理、圧縮
- **コスト**: Workers 実行時間、R2 ストレージ、帯域幅

### ステップ4: 実装とコード生成

**提供する成果物**:

1. **Workers スクリプト**
   - TypeScript/JavaScript コード
   - wrangler.toml 設定ファイル
   - 環境変数とシークレット管理

2. **Pages 設定**
   - ビルド設定（next.config.js 等）
   - デプロイメント設定
   - カスタムドメインと DNS 設定

3. **ストレージ統合**
   - R2 バケット設定
   - D1 データベーススキーマ
   - KV 名前空間設定

4. **デプロイ手順**
   - wrangler コマンド
   - CI/CD パイプライン設定（GitHub Actions 等）
   - ロールバック手順

**コード品質基準**:
- エラーハンドリングとリトライロジックの実装
- ログ出力（Workers Logs/Logpush 統合）
- パフォーマンスモニタリング（Analytics Engine）
- 環境変数による設定の外部化

### ステップ5: デプロイと検証

**実施内容**:
- デプロイ手順の説明（ステップバイステップ）
- 初回デプロイ時の注意事項
- 動作確認方法とテストシナリオ

**検証項目**:
- Workers/Pages が正しくデプロイされているか確認
- DNS レコード、ルーティングが適切か検証
- パフォーマンス、レスポンスタイムを測定
- ログ、メトリクスが正しく収集されているか確認

### ステップ6: モニタリングとトラブルシューティング

**設定すべき監視項目**:
- Workers Analytics（リクエスト数、エラー率、CPU 時間）
- Web Analytics（トラフィック、パフォーマンス）
- Logpush（構造化ログの外部送信）
- Health Checks（エンドポイント監視）

**トラブルシューティング手法**:
- よくある問題とその解決方法
- ログ分析のベストプラクティス
- パフォーマンス問題の診断手順

## 専門分野とサービスカタログ

このスキルは以下の Cloudflare サービス分野をカバーします。詳細な実装ガイドは `./SERVICE_CATALOG.md` を参照してください。

### カバーするサービス分野

- **エッジコンピューティング**: Workers, Pages, Durable Objects
- **ストレージ**: R2, KV, D1, Queues
- **ネットワーキング**: Load Balancing, Argo Smart Routing, Spectrum
- **セキュリティ**: WAF, DDoS Protection, Zero Trust, Access
- **パフォーマンス**: CDN, Image Optimization, Stream
- **開発者ツール**: wrangler CLI, Playground, Miniflare

**詳細ガイド**: サービスごとの実装パターン、ユースケース、コード例は `./SERVICE_CATALOG.md` を参照

## 実装パターンとベストプラクティス

### サーバーレス API

**構成要素**:
- Workers + D1 Database
- Workers + KV Storage
- Workers + R2 Object Storage

**ベストプラクティス**:
- ステートレス設計
- エッジでのデータキャッシュ
- 効率的な DB クエリ（D1 Prepared Statements）

### JAMstack アプリケーション

**構成要素**:
- Pages + Workers Functions
- Pages + D1/KV
- Pages + R2 Assets

**ベストプラクティス**:
- ビルド時の静的生成
- エッジでの動的レンダリング（ISR）
- 環境変数による設定管理

### データパイプライン

**構成要素**:
- Workers + Queues
- Workers + R2
- Workers + Durable Objects

**ベストプラクティス**:
- 非同期処理パターン
- バッチ処理の最適化
- 障害時のリトライ戦略

## 実装例

よくある実装パターンの具体例は `./EXAMPLES.md` を参照してください：

- REST API（Workers + D1）
- 画像最適化サービス（Workers + R2）
- リアルタイムチャット（Durable Objects + WebSocket）
- 静的サイト + API（Pages + Workers Functions）

## デフォルト設定

ユーザーから特別な指示がない限り、以下のデフォルト設定で実装を進めます：

### 開発環境

| 項目 | デフォルト値 | 理由 |
|------|-------------|------|
| ランタイム | Workers（Service Worker 形式） | 標準的な Workers 形式 |
| 言語 | TypeScript | 型安全性、開発体験 |
| ツール | wrangler CLI | 公式ツール、機能豊富 |

### セキュリティ

| 項目 | デフォルト値 | 理由 |
|------|-------------|------|
| HTTPS | 強制 | セキュリティベストプラクティス |
| WAF | 有効（マネージドルール） | 基本的な保護 |
| Rate Limiting | 推奨設定 | DoS 攻撃対策 |

### パフォーマンス

| 項目 | デフォルト値 | 理由 |
|------|-------------|------|
| キャッシュ | 積極的（CDN + Workers Cache API） | レイテンシ削減 |
| 圧縮 | Brotli/Gzip 有効 | 帯域幅削減 |
| Minification | 有効 | ページサイズ削減 |

## 注意事項

1. **サービス制限**: Workers CPU 時間（10ms/50ms）、メモリ（128MB）等の制限を考慮
2. **料金**: 無料枠（Workers: 100,000 req/day）と有料プランの違いを明示
3. **セキュリティ**: シークレット管理、CORS 設定、CSP ヘッダーの適用
4. **パフォーマンス**: キャッシュ戦略、オリジンへのリクエスト最小化
5. **互換性**: Workers Runtime と Node.js の違いに注意
6. **テスト**: Miniflare でのローカルテスト推奨

## エラーハンドリング

### よくあるエラーと対処法

**MCP ツールエラー**:
- MCP サーバーが利用できない場合、一般的な知識で回答するが、その旨を明示
- API レート制限に達した場合、待機時間を提案

**実装エラー**:
- Workers CPU 時間超過: 処理の最適化または Durable Objects への移行を提案
- メモリ制限: データ処理の分割またはストリーミングを提案
- DNS 設定エラー: DNS レコードの確認と修正手順を提示

**デプロイエラー**:
- wrangler のビルド失敗: エラーメッセージ分析と依存関係確認
- Pages ビルドエラー: ビルドログの分析とビルド設定の見直し

## 依存関係

このスキルが正常に動作するために必要な依存関係：

### 必須依存関係

- **cloudflare-mcp-server** (`cloudflare:mcp-server-cloudflare`)
  - Cloudflare リソースの取得と操作に使用
  - 使用するツール:
    - リソース一覧取得
    - ゾーン設定確認
    - アナリティクスデータ取得

### オプション依存関係

- **wrangler CLI**: Workers/Pages のデプロイと管理に必要
- **Node.js/npm**: ローカル開発とビルドに使用
- **Miniflare**: ローカルテスト環境

### 関連スキル

- `reviewing-cloudflare-infrastructure`: 実装後のインフラレビュー
- `researching-cloudflare-resources`: 詳細なリソース情報取得

このスキルにより、Cloudflare サービスの実装を、正確で高性能、かつスケーラブルな形で実現できます。
