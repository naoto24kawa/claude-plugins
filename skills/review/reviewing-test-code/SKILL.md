---
name: reviewing-test-code
description: テスト実装コードを5つの専門エージェント（AAA構造、Test Double、Test Builder、SOLID原則、TypeScript型安全性）とコーディネーターで多角的にレビューし、トレードオフを考慮した優先度付きテスト品質改善計画を策定する。「テストレビュー」「テスト品質」「テストリファクタリング」「テストカバレッジ」「モック適切性」「AAA構造」「型安全性」などの依頼時、またはテスト実装後の品質確認が必要な時に使用
---

## テスト実装レビューシステム

このスキルは、実装されたテストコードを複数の専門エージェントで多角的にレビューし、品質向上のための具体的かつ現実的な改善提案を行います。テスト特有のトレードオフ（AAA厳格性 vs Builder柔軟性、網羅性 vs 実行速度など）を考慮した統合的な改善計画を策定します。

## 実行方法

対象となるテストファイルまたはテストディレクトリを指定して、以下の専門エージェントによるレビューを実行し、コーディネーターエージェントが統合レポートを作成します。

## 使用するエージェント

このスキルは以下の専門エージェントを使用します（すべてマーケットプレースに登録済み）:

| エージェント名 | ファイルパス | 役割 | 評価観点 |
|---------------|-------------|------|----------|
| @agent-test-aaa-test-agent | `agents/test/aaa-test-agent.md` | AAA構造評価 | Arrange-Act-Assert の各セクション分離、可読性、構造の明確さ |
| @agent-test-test-double-agent | `agents/test/test-double-agent.md` | Test Double評価 | Mock/Stub/Fake の使い分け、過度なMockの検出 |
| @agent-test-test-builder-agent | `agents/test/test-builder-agent.md` | Test Builder評価 | データ生成の保守性、Builder適用の適切性 |
| @agent-test-solid-test-agent | `agents/test/solid-test-agent.md` | SOLID原則評価 | テストコードの密結合検出、依存性注入の適切性 |
| @agent-review-typescript-comprehensive | `agents/review/typescript-comprehensive.md` | TypeScript型安全性評価 | 型定義の厳格性、any使用率、型アサーションの適切性 |
| @agent-test-coordinator | `agents/test/coordinator.md` | 統合分析 | トレードオフ分析、優先度付け、統合レポート作成 |

**注意**: これらのエージェントがマーケットプレース（`.claude-plugin/marketplace.json`）に登録されていることを確認してください。

## 使用例

### 例 1: 単一テストファイルのレビュー

**状況**: 新機能のテスト実装後の品質確認

**実行手順**:
1. Claude Codeで `/skill reviewing-test-code` を実行
2. 対象ファイルを指定: `tests/services/user-service.test.ts`
3. 5つのエージェントが並行実行され、約2-3分でレポート生成

**期待される出力**:
- AAA構造の評価（準拠率 85%）
- Mock使用箇所の分析（10箇所中3箇所で改善提案）
- 優先度付きタスクリスト（Critical: 0件、High: 2件、Medium: 5件）
- 段階的実装計画（Phase 1-4）

### 例 2: テストスイート全体のレビュー

**状況**: E2Eテストのリファクタリング前の現状分析

**実行手順**:
1. Claude Codeで `/skill reviewing-test-code` を実行
2. 対象ディレクトリを指定: `tests/integration/`
3. 約5-7分でディレクトリ内すべてのテストファイルをレビュー

**期待される出力**:
- Test Builderパターン適用可能性（20ファイル中12ファイルで有効）
- 重複コード削減提案（現在35%の重複 → 10%以下に削減可能）
- テスト実行時間改善策（現在8分 → 並列化で3分に短縮可能）
- 保守性向上のための優先タスク（High: 8件、Medium: 15件）

### 例 3: プロジェクト全体のテスト品質監査

**状況**: 定期的なテスト品質監査とカバレッジ改善

**実行手順**:
1. Claude Codeで `/skill reviewing-test-code` を実行
2. 対象ディレクトリを指定: `tests/`（全テストファイル）
3. 約10-15分で全テストファイル（150ファイル）をレビュー

**期待される出力**:
- 包括的な品質評価（総合スコア: B、カバレッジ 72% → 85%目標）
- 優先度付き改善計画（Critical: 5件、High: 25件、Medium: 60件、Low: 80件）
- 段階的実装ロードマップ（Phase 1: 1週間、Phase 2: 2週間、Phase 3: 1ヶ月）
- 工数見積もり（Phase 1: 3人日、Phase 2: 10人日、Phase 3: 20人日）
- 期待効果（カバレッジ向上、テスト実行時間30%短縮、保守コスト50%削減）

## レビュータスク

### 1. 多角的テスト実装レビューの実施

以下の専門エージェントを並行または順次実行してレビューを収集：

- @agent-test-aaa-test-agent による Arrange-Act-Assert 構造の評価
- @agent-test-test-double-agent による Mock/Stub/Fake の適切性評価
- @agent-test-test-builder-agent による Test Data Builder の保守性評価
- @agent-test-solid-test-agent による SOLID 原則遵守度の評価
- @agent-review-typescript-comprehensive による TypeScript 型安全性とベストプラクティス評価

**エージェント実行の詳細**:

- 各エージェントは独立した専門観点でテストコードを評価
- テスト実行速度、可読性、保守性、型安全性など多角的な評価
- 具体的な改善コード例とビフォー・アフター比較を提供

### 2. テスト品質の総合評価と統合

@agent-test-coordinator がすべてのエージェント結果を統合し、以下の観点で総合評価を実施：

**主な評価観点**:

- テストコードの可読性と保守性
- テスト実行速度と効率性
- テストカバレッジの妥当性とギャップ分析
- TypeScript 型安全性によるテスト信頼性
- エラーハンドリングとエッジケース対応の充実度

**トレードオフ分析**:

- AAA 構造の厳格性 vs Test Builder の柔軟性バランス
- Test Double の分離 vs SOLID 統合性のトレードオフ
- TypeScript 型安全性の厳格性 vs テストコードの簡潔性
- テスト網羅性 vs 実行パフォーマンスの最適化
- 保守性向上 vs 実装工数のバランス調整

**詳細な分析手法**: `./ANALYSIS_GUIDE.md` を参照

### 3. 優先度付き改善タスクの策定

すべてのレビュー結果を基に、`./REPORT_TEMPLATE.md` の形式で統合レポートを作成：

**優先度分類**:

- 🔴 緊急修正（Critical）: テスト失敗、型安全性違反、カバレッジ不足
- 🟡 重要改善（High）: 構造化不備、パフォーマンス問題、保守性向上
- 🟢 推奨最適化（Medium）: リファクタリング、パターン適用、可読性向上
- 💡 学習機会（Low）: 新しい手法導入、ベストプラクティス適用

**必須セクション**:

- 優先度付きタスクリスト（各タスクに工数見積もりを含む）
- Phase 1-4 の段階的実装計画
- トレードオフ分析と判断根拠
- リスク評価と軽減策
- 成功指標（改善前後の測定可能な指標）

**レポートテンプレート**: `./REPORT_TEMPLATE.md` を使用

### 4. テスト品質メトリクスの定義

改善効果を測定するための具体的な指標を設定：

**主要メトリクス**:

- **カバレッジ指標**: 行/分岐/関数/条件カバレッジ、ミューテーションスコア
- **可読性指標**: AAA構造準拠率、テスト名の明確性、コメント充実度
- **保守性指標**: Test Builder使用率、重複コード削減率、依存関係の分離度
- **実行効率指標**: テスト実行速度、並列化可能性、リソース使用量
- **型安全性指標**: 型カバレッジ、any 使用率、型アサーションの適切性

**詳細な指標ガイド**: `./METRICS.md` を参照

## 実行手順（検証付きワークフロー）

### ステップ 1: 対象の指定と準備

- レビュー対象のテストファイル/ディレクトリを明確に指定
- **検証**: 対象が存在し、有効なテストファイル（*.test.ts, *.spec.ts など）であることを確認
- **エラー時**: テストファイルが見つからない場合はユーザーに確認を求める

### ステップ 2: 専門エージェント実行

- 各専門エージェントを並行または順次実行
  - @agent-test-aaa-test-agent（AAA構造評価）
  - @agent-test-test-double-agent（Mock/Stub/Fake評価）
  - @agent-test-test-builder-agent（Test Builder保守性評価）
  - @agent-test-solid-test-agent（SOLID原則評価）
  - @agent-review-typescript-comprehensive（TypeScript型安全性評価）
- **検証**: すべてのエージェントが正常に完了したか確認
- **エラー時**: 失敗したエージェントのみ再実行、または部分的な結果で続行
- **パフォーマンス**: 大規模プロジェクトの場合、並行実行で時間短縮

### ステップ 3: 結果収集と検証

- 各エージェントのレビュー結果を収集
- **検証**:
  - 各エージェントの出力が有効な形式（構造化された評価結果）であることを確認
  - 空の結果や不完全な出力がないか確認
  - 具体的な改善提案とコード例が含まれているか確認
- **エラー時**: 不完全な結果は除外し、取得できた結果のみで分析
- **データ整理**: 各エージェントの結果を統一形式に変換

### ステップ 4: コーディネーターによる統合分析

- @agent-test-coordinator がすべてのエージェント結果を統合
- トレードオフを考慮した統合分析を実施
- 相反する提案の調整と優先度付け
- **検証**:
  - 相反する提案（例: AAA厳格性 vs Builder柔軟性）がリストアップされているか確認
  - 各優先度レベル（Critical/High/Medium/Low）にタスクが分類されているか確認
  - Phase 1-4 の段階的実装計画が策定されているか確認
- **エラー時**: 手動で優先度を調整、またはトレードオフを再評価

### ステップ 5: 統合レポート作成と出力

- 優先度付きタスクリストと段階的実装計画を作成
- REPORT_TEMPLATE.md の形式に従って出力
- **検証**:
  - レポートに必須セクション（エグゼクティブサマリー、優先度別タスク、実装計画、リスク評価、成功指標）が含まれているか確認
  - 各タスクに工数見積もり（XS/S/M/L/XL）が付与されているか確認
  - ビフォー・アフターのコード例が具体的に提示されているか確認
  - チームスキルレベルに応じた実装難易度の調整がされているか確認
- **出力**: 統合レポートを Markdown 形式で提供
- **フォローアップ**: 継続的品質向上の仕組み（チェックリスト、自動化項目、ガイドライン）を提案

## デフォルト設定

ユーザーから特別な指示がない限り、以下のデフォルト設定で実行：

### 実行方式

| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| エージェント実行 | 並行実行 | 5つすべてのエージェントを並行実行（大規模プロジェクトでは時間短縮のため） |
| コーディネーター | 全エージェント完了後 | すべてのエージェント完了後に @agent-test-coordinator を実行 |
| 失敗時の処理 | 部分的レポート生成 | エラーが発生した場合、その旨を報告し、取得できた結果のみでレポート生成 |
| 対象範囲 | 指定パスのみ | ユーザーが指定したテストファイル/ディレクトリのみ（サブディレクトリは含まない、明示的指定があれば再帰的に処理） |

### 出力形式

| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| レポート形式 | Markdown | 統合レポートをMarkdown形式で出力 |
| 優先度基準 | 4段階 | Critical > High > Medium > Low で評価 |
| 工数表記 | 5段階 | XS（1時間未満）/ S（1-4時間）/ M（1-2日）/ L（3-5日）/ XL（1週間以上） |
| コード例 | ビフォー・アフター | 具体的な改善例をビフォー・アフター形式で提示 |

### 分析基準

| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| トレードオフ判断 | 信頼性優先 | テスト信頼性 > 保守性 > 実行速度 > コード簡潔性 の優先順位 |
| 実用性重視 | 現実的な提案 | 理想的なテスト設計より、現実的で実装可能な提案を優先 |
| 段階的改善 | Phase 1-4 | 一度にすべてを修正するのではなく、Phase分けで段階的な改善計画を提示 |
| チーム適合性 | スキルレベル考慮 | チームのスキルレベルと利用可能なリソースを考慮した提案 |

### テスト品質基準

| 項目 | 推奨値 | 説明 |
|------|--------|------|
| AAA構造 | 推奨（柔軟性も考慮） | Arrange-Act-Assert の明確な分離を推奨（ただし柔軟性も考慮） |
| Test Double | 必要最小限 | 外部依存のみMock、過度なモック化を避ける |
| カバレッジ目標 | 重要: 80%以上、全体: 70%以上 | 重要なビジネスロジックは80%以上、全体は70%以上を推奨 |
| 型安全性 | any使用率5%以下 | テストコードでも型安全性を確保、anyの使用は最小限に |

## 注意事項

1. **対象指定**: テストファイルまたはテストディレクトリを明確に指定してください
2. **プロジェクト規模考慮**: 大規模プロジェクトの場合、段階的にレビュー範囲を拡大することを推奨
3. **チームスキル**: チームのテスト実装スキルレベルを考慮した現実的な提案を行います
4. **実装工数**: 優先度と工数を明示し、リソース制約を考慮した実装計画を提案
5. **CI/CD 整合性**: 既存の CI/CD パイプラインとの整合性を確保します
   - 例: GitHub Actions の jest カバレッジ閾値（`coverageThreshold`）との整合性確認
   - 例: GitLab CI のテスト実行時間制限（例: 15分）を考慮した並列化提案
   - 例: CircleCI の並列実行設定（`parallelism`）に適したテストグループ分け提案
6. **パフォーマンス**: テスト実行速度への影響を考慮した改善提案を行います
7. **ビジネス価値**: テスト品質向上がビジネス価値に結びつく提案を優先します
8. **継続的改善**: 一度のレビューで終わらず、継続的な品質向上サイクルの確立を支援します

## 実装改善の具体的ガイダンス

レポートには以下の要素を含めます：

- **ビフォー・アフター**: 具体的なコード比較例
- **段階的リファクタリング**: Phase 1-4 の詳細な手順
- **効果測定**: 各改善による定量的なメリット（カバレッジ向上率、実行速度改善率など）
- **難易度調整**: チームスキルレベルに応じた実装難易度の提示
- **TypeScript 整合性**: TypeScript エコシステムとの整合性確保

## 継続的品質向上の仕組み

レビュー後、以下の継続的改善策を提案します：

- **テストレビュー基準**: チーム共有のチェックリスト作成
- **自動化**: Lint ルールや CI チェックで自動化可能な項目の特定
- **スキル向上**: チーム全体のテストスキル向上計画
- **ガイドライン**: 新規テスト実装時のガイドライン整備
- **定期評価**: 四半期ごとのテスト品質評価サイクル確立

このテストレビューシステムにより、テストコードの品質向上と保守性確保を、現実的かつ段階的に進めることができます。
